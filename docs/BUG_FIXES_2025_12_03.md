# POSBASE 논리 오류 테스트 및 수정 보고서

**테스트 일시**: 2025-12-03
**테스트 방법**: 시드 데이터 스크립트를 통한 전체 플로우 검증

---

## 발견된 버그 및 수정 사항

### 1. [수정완료] 시드 스크립트 - FK 제약조건 위반

**파일**: `backend/seed_demo_data.sql`

**문제점**:
- `sale_items`를 `sales`보다 먼저 INSERT 시도
- FK 제약조건 위반으로 스크립트 실행 실패

**원인**:
```sql
-- 잘못된 순서
FOR j IN 1..n LOOP
  INSERT INTO sale_items (...) VALUES (...);  -- sales가 없어서 실패!
END LOOP;
INSERT INTO sales (...) VALUES (...);
```

**수정 방법**:
- 임시 테이블 `temp_sale_items` 사용
- `sales` INSERT → `sale_items` INSERT 순서로 변경
- 재고 차감도 일괄 처리로 변경

---

### 2. [수정완료] useCancelSale - 재고 복원 로직 오류

**파일**: `frontend/src/hooks/useSales.ts` (Lines 177-193)

**문제점**:
```typescript
// 존재하지 않는 RPC 함수 호출 시도
await supabase.rpc('restore_stock_on_cancel', {...})

// 잘못된 폴백 - .rpc()를 .update() 안에서 호출 (작동 안 함)
.update({ stock: supabase.rpc('increment_stock', {...}) })
```

**증상**:
- 판매 취소 시 재고가 복원되지 않음
- 재고 로그도 기록되지 않음

**수정 방법**:
```typescript
// 현재 재고 조회
const { data: variant } = await supabase
  .from('product_variants')
  .select('stock')
  .eq('id', item.variant_id)
  .single()

// 재고 복원
await supabase
  .from('product_variants')
  .update({ stock: beforeStock + item.quantity })
  .eq('id', item.variant_id)

// 재고 로그 기록
await supabase.from('stock_logs').insert({
  user_id: user.id,
  variant_id: item.variant_id,
  change_type: 'cancel',
  quantity: item.quantity,
  before_stock: beforeStock,
  after_stock: afterStock,
  reference_id: id,
  memo: '판매 취소',
})
```

---

## 검증 완료된 로직

### 정상 작동 확인:

1. **판매 생성** (`useSales.ts` > `useCreateSale`)
   - ✅ `sales` 먼저 INSERT → `sale_items` INSERT
   - ✅ 롤백 처리 구현됨

2. **DB 트리거**
   - ✅ `trg_sale_balance`: 외상 판매 시 잔액 증가
   - ✅ `trg_payment_balance`: 입금 시 잔액 감소
   - ✅ `trg_sale_item_stock`: 판매 시 재고 차감 + 로그 기록
   - ✅ `trg_return_completion`: 반품 완료 시 재고 복원 + 외상 조정

3. **미송 완료** (`useBackorders.ts` > `useCompleteBackorder`)
   - ✅ 재고 확인 후 차감
   - ✅ 재고 로그 기록

4. **반품 완료** (`useReturns.ts` > `useCompleteReturn`)
   - ✅ 트리거에 위임하여 정상 처리

5. **입금 처리** (`usePayments.ts` > `useCreatePayment`)
   - ✅ 트리거에 위임하여 잔액 자동 차감

---

## 향후 권장 사항

1. **단위 테스트 추가**: 핵심 비즈니스 로직에 대한 테스트 코드 작성
2. **트랜잭션 처리**: 복잡한 작업에 대해 DB 트랜잭션 적용 검토
3. **Race Condition 대비**: 동시 접속 시나리오 테스트 (현재는 1인 사용 기준)

---

## 수정된 파일 목록

| 파일 | 변경 내용 |
|------|----------|
| `backend/seed_demo_data.sql` | FK 순서 수정, 임시 테이블 사용 |
| `frontend/src/hooks/useSales.ts` | useCancelSale 재고 복원 로직 수정 |
